name: Demo Issue Form Opened

on:
  issues:
    types:
      - opened
      - reopened

# jobs:
#   parse_issue_labels:
#     if: |
#       contains(github.event.issue.labels.*.name, 'demo')
#       && contains(github.event.issue.labels.*.name, 'template')
#     uses: msanzdelrio-demo-resources/demo-workflows-bootstrap/.github/workflows/demo_create.yml@main
#     with:
#       user_name: ${{ github.event.issue.body.user.name }}
#       organization_name: ${{ github.event.issue.body.organization.value }}
#       repository_name: ${{ github.event.issue.body.repository }}

jobs:
  parse_issue_labels:
    runs-on: ubuntu-20.04
    outputs:
      user: ${{ steps.generate_variables.outputs.user }}
      organization: ${{ steps.generate_variables.outputs.organization }}
      repository: ${{ steps.generate_variables.outputs.repository }}
    steps:
      - name: Run Issue form parser
        id: parse
        uses: peter-murray/issue-forms-body-parser@v2.0.0
        with:
          issue_id: ${{ github.event.issue.number }}
          separator: '###'
          label_marker_start: '>>'
          label_marker_end: '<<'

      - name: Publish output variables
        uses: actions/github-script@v5
        id: generate_variables
        env:
          demo_payload: ${{ steps.parse.outputs.payload  }}
        with:
          script: |
            demoPayload = JSON.parse(process.env.demo_payload);
            const user = demoPayload['User-Handle'];
            echo demoPayload;
            const organization = demoPayload['Target-Organization'];
            const repository = demoPayload['Demo-Repository'];
            core.setOutput('user', user);
            core.setOutput('organization', organization);
            core.setOutput('repository', repository);
      - run: |
          echo "${{ steps.generate_variables_output.user }}"

  # trigger_demo_creation:
  #   needs:
  #     - parse_issue_labels
  #   if: |
  #     contains(github.event.issue.labels.*.name, 'demo')
  #     && contains(github.event.issue.labels.*.name, 'template')
  #   uses: msanzdelrio-demo-resources/demo-workflows-bootstrap/.github/workflows/demo_create.yml@main
  #   with:
  #     user_name: ${{ github.needs.parse_issue_labels.outputs.user }}
  #     organization_name: ${{ github.needs.parse_issue_labels.outputs.organization }}
  #     repository_name: ${{ github.needs.parse_issue_labels.outputs.repository }}